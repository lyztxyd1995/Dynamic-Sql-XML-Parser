<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings namespace="v1.admanager.AdRefreshDaoImpl">
    <named-native-query name="deleteAdRefreshes">
        DELETE
        FROM ADREFRESH
        WHERE date = ?
    </named-native-query>

    <named-native-query name="getRefreshImpressionsMap">
        SELECT deviceType, SUM(impression) AS impressions
        FROM ADREFRESH
        WHERE date = #{date}
        <if text="siteUUID != null">
            AND siteUUID = #{siteUUID}
        </if>
        <if text="impressionType != null">
            AND impressionType = #{impressionType}
        </if>
        <if text="ssps!=null and devices != null">
            AND ssp IN (:ssps) AND devices IN (:devices)
        </if>
        GROUP BY deviceType
    </named-native-query>

    <named-native-query name="getRefreshImpressionsMapNew">
        SELECT siteUUID, deviceType, SUM(impression) AS impressions
        <switch>
            <case text = " revenueType ==  'display'">
                FROM ADREVENUE
            </case>
            <case text = " revenueType ==  'video'">
                FROM VIDEOREVENUE
            </case>
            <otherwise>
                FROM SITEREVENUE
            </otherwise>
        </switch>
        WHERE date = ?
        AND impressionType != ?
        AND ssp IN (:ssps)
        GROUP BY deviceType, siteUUID
    </named-native-query>

    <named-native-query name="getAdRefreshRateMapForAllSites">
        SELECT totalTable.siteUUID, totalTable.deviceType, refreshTable.refreshMount / totalTable.totalMount AS
        refreshRate
        FROM (SELECT siteUUID, deviceType, SUM(impression) AS refreshMount
        FROM ADREFRESH
        WHERE date = ?
        AND impressionType != "INITIAL_LOAD"
        AND ssp NOT IN ('Taboola', 'Insticator')
        GROUP BY deviceType, siteUUID)
        AS refreshTable
        JOIN
        (SELECT siteUUID, deviceType, SUM(impression) totalMount
        FROM ADREFRESH
        WHERE date = ?
        AND ssp NOT IN ('Taboola', 'Insticator')
        GROUP BY deviceType, siteUUID
        HAVING totalMount > 0)
        AS totalTable
        ON totalTable.siteUUID = refreshTable.siteUUID
        AND totalTable.deviceType = refreshTable.deviceType
    </named-native-query>
</entity-mappings>